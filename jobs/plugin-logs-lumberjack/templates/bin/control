#!/bin/bash

set -e
set -u

PIDFILE=/var/vcap/sys/run/plugin-logs-lumberjack/control.pid
LOGDIR=/var/vcap/sys/log/plugin-logs-lumberjack
DATADIR=/var/vcap/data/plugin-logs-lumberjack

mkdir -p `dirname "$PIDFILE"`
chown vcap:vcap `dirname "$PIDFILE"`

mkdir -p "$LOGDIR"
chown vcap:vcap "$LOGDIR"

mkdir -p "$DATADIR"
chown vcap:vcap "$DATADIR"

exec >> /var/vcap/sys/log/plugin-logs-lumberjack/control.log
exec 2>&1


case $1 in

  start)
    <% if_p('plugin.logs.start_delay') do | v | %>
    sleep <%= v %>
    <% end %>

    /var/vcap/jobs/plugin-logs-lumberjack/bin/generate-config > $DATADIR/config.json

    /sbin/start-stop-daemon \
      --background \
      --pidfile $PIDFILE \
      --exec /bin/bash \
      --make-pidfile \
      --chdir "$DATADIR" \
      --start \
      -- -c "exec /var/vcap/packages/plugin-logs-logstash-forwarder/bin/logstash-forwarder \
        -config config.json \
        <% if_p('plugin.logs.lumberjack.idle_flush_time') do | v | %> -idle-flush-time=<%= v %><% end %> \
        <% if_p('plugin.logs.lumberjack.spool_size') do | v | %> -spool-size=<%= v %><% end %> \
        >> \"$LOGDIR/stdout.log\" \
        2>> \"$LOGDIR/stderr.log\" \
      "

    ;;

  stop)
    /sbin/start-stop-daemon \
      --pidfile $PIDFILE \
      --signal INT \
      --oknodo \
      --stop \
      --retry 15

    ;;

  *)
    echo "Usage: control {start|stop}" >&2

    exit 1

    ;;

esac
